<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Muhammad Dildar | Portfolio & Voting System (Static Fallback)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 'midnight': '#0F172A', 'electric': '#06B6D4', 'accent-light': '#BAE6FD' }
                }
            }
        }
    </script>
    <style>
        /* (styles are the same as your original ‚Äî trimmed here for brevity in this snippet) */
        .fade-in-section{opacity:0;transform:translateY(20px);transition:opacity 1.2s ease-out,transform 0.8s ease-out}
        .is-visible{opacity:1;transform:translateY(0)}
        .hero-text-gradient{background-image:linear-gradient(45deg,#E2E8F0,#06B6D4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;color:transparent}
        .candidate-circle{width:200px;height:200px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:4rem;font-weight:bold;color:white;cursor:pointer;transition:all .3s ease;border:4px solid transparent;position:relative;overflow:hidden}
        .candidate-circle::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#06B6D4,#0891B2);opacity:0;transition:opacity .3s}
        .candidate-circle:hover::before{opacity:.2}
        .candidate-circle:hover{transform:scale(1.1);border-color:#06B6D4;box-shadow:0 0 30px rgba(6,182,212,.5)}
        .candidate-circle.selected{border-color:#06B6D4;box-shadow:0 0 40px rgba(6,182,212,.8);transform:scale(1.05)}
        .candidate-name{margin-top:1.5rem;font-size:1.5rem;font-weight:bold;color:#E2E8F0;transition:color .3s}
        .login-card{background:#1E293B;border:2px solid #06B6D4;box-shadow:0 20px 60px rgba(6,182,212,.3)}
        .dashboard-card{background:#1E293B;border:2px solid #06B6D4;box-shadow:0 20px 60px rgba(6,182,212,.3)}
        .stat-card{background:rgba(6,182,212,.1);border:1px solid #06B6D4}
        .view-section{display:none}
        .view-section.active{display:block}
    </style>
</head>
<body class="bg-midnight min-h-screen text-gray-100 font-sans antialiased">
<header class="p-4 border-b border-gray-800 shadow-lg sticky top-0 z-10 bg-midnight/90 backdrop-blur-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-extrabold text-electric cursor-pointer" onclick="showView('portfolio')">Dildar.dev</h1>
        <nav class="flex gap-4 items-center">
            <button onclick="showView('portfolio')" class="text-sm font-medium hover:text-electric transition duration-300">Portfolio</button>
            <button onclick="showView('vote')" class="px-4 py-2 bg-electric text-midnight font-semibold rounded-lg hover:bg-electric/80 transition duration-300 shadow-lg hover:shadow-electric/50">Vote</button>
            <button onclick="showView('admin-login')" class="px-4 py-2 bg-gray-700 text-gray-100 font-semibold rounded-lg hover:bg-gray-600 transition duration-300">Admin</button>
        </nav>
    </div>
</header>

<!-- Portfolio (same as original) -->
<div id="portfolio-view" class="view-section active">
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <section class="min-h-[60vh] flex items-center justify-center text-center fade-in-section" data-delay="0">
            <div>
                <p class="text-xl sm:text-2xl text-accent-light mb-4 font-light tracking-wide">Future-Forward Engineer & Entrepreneur</p>
                <h2 class="text-7xl sm:text-9xl font-black leading-tight hero-text-gradient">Muhammad Dildar</h2>
                <div id="countdown-container" class="mt-8 mb-6 fade-in-section" data-delay="100">
                    <p class="text-2xl sm:text-3xl font-extrabold text-electric mb-3 tracking-widest">COME BACK HOME WALA HAI</p>
                    <div id="countdown" class="text-3xl sm:text-5xl font-mono text-accent-light bg-gray-900/50 p-4 rounded-xl shadow-inner inline-block border-2 border-electric/50"></div>
                </div>
                <p class="mt-6 text-2xl sm:text-3xl font-medium text-gray-400 fade-in-section" data-delay="200">Building the future, one line of code at a time.</p>
            </div>
        </section>
    </main>
</div>

<!-- Vote view -->
<div id="vote-view" class="view-section">
    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 mt-12">
        <div id="voting-container">
            <h2 class="text-5xl font-bold text-center mb-4 text-electric">Cast Your Vote</h2>
            <p class="text-xl text-center text-gray-400 mb-12">Choose your preferred candidate</p>
            <div id="candidates-container" class="flex flex-col md:flex-row gap-12 justify-center items-center mb-8"></div>
            <div class="text-center">
                <button id="submit-vote-btn" class="px-8 py-4 bg-electric text-midnight font-bold text-xl rounded-lg hover:bg-electric/80 transition duration-300 shadow-lg hover:shadow-electric/50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Submit Vote</button>
            </div>
        </div>

        <div id="vote-success" class="hidden text-center vote-success">
            <div class="inline-block p-8 bg-gray-800 rounded-2xl border-2 border-electric">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-3xl font-bold text-electric mb-4">Vote Submitted Successfully!</h3>
                <p class="text-xl text-gray-300 mb-6">Thank you for participating. Your vote has been recorded.</p>
                <div id="results-preview" class="hidden mt-6 p-6 bg-gray-900 rounded-lg">
                    <h4 class="text-2xl font-bold text-electric mb-4">Final Results</h4>
                    <div id="results-content"></div>
                </div>
                <button onclick="showView('portfolio')" class="mt-6 px-6 py-3 bg-electric text-midnight font-semibold rounded-lg hover:bg-electric/80 transition duration-300">Return Home</button>
            </div>
        </div>

        <div id="already-voted" class="hidden text-center">
            <div class="inline-block p-8 bg-gray-800 rounded-2xl border-2 border-gray-600">
                <div class="text-6xl mb-4">‚ÑπÔ∏è</div>
                <h3 class="text-3xl font-bold text-gray-400 mb-4">You Have Already Voted</h3>
                <p class="text-xl text-gray-300 mb-6">You can only vote once. Results will be revealed when the admin makes them public.</p>
                <div id="results-preview-voted" class="hidden mt-6 p-6 bg-gray-900 rounded-lg">
                    <h4 class="text-2xl font-bold text-electric mb-4">Final Results</h4>
                    <div id="results-content-voted"></div>
                </div>
                <button onclick="showView('portfolio')" class="mt-6 px-6 py-3 bg-electric text-midnight font-semibold rounded-lg hover:bg-electric/80 transition duration-300">Return Home</button>
            </div>
        </div>
    </main>
</div>

<!-- Admin Login -->
<div id="admin-login-view" class="view-section">
    <div class="min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-md">
            <div class="login-card rounded-2xl p-8">
                <h1 class="text-4xl font-bold text-center mb-2 text-electric">Admin Login</h1>
                <p class="text-center text-gray-400 mb-8">Enter your credentials to access the admin panel</p>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-accent-light mb-2">Username</label>
                        <input type="text" id="username" name="username" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-electric focus:ring-2 focus:ring-electric/50 text-white" placeholder="Enter username">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-accent-light mb-2">Password</label>
                        <div class="password-container relative">
                            <input type="password" id="password" name="password" required class="w-full px-4 py-3 pr-12 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-electric focus:ring-2 focus:ring-electric/50 text-white" placeholder="Enter password">
                            <button type="button" id="toggle-password" class="eye-button absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div id="error-message" class="hidden text-red-400 text-sm text-center"></div>
                    <button type="submit" class="w-full px-6 py-3 bg-electric text-midnight font-bold rounded-lg hover:bg-electric/80 transition duration-300 shadow-lg hover:shadow-electric/50">Login</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Admin Dashboard -->
<div id="admin-dashboard-view" class="view-section">
    <header class="p-4 border-b border-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-electric">Admin Dashboard</h1>
            <div class="flex gap-4 items-center">
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300">Logout</button>
            </div>
        </div>
    </header>
    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 mt-8">
        <div class="dashboard-card rounded-2xl p-8 mb-8">
            <h2 class="text-3xl font-bold mb-6 text-electric">Set Candidates</h2>
            <form id="candidates-form" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="person1" class="block text-sm font-medium text-accent-light mb-2">Person 1 Name</label>
                        <input type="text" id="person1" name="person1" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-electric focus:ring-2 focus:ring-electric/50 text-white" placeholder="Enter first person's name">
                    </div>
                    <div>
                        <label for="person2" class="block text-sm font-medium text-accent-light mb-2">Person 2 Name</label>
                        <input type="text" id="person2" name="person2" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-electric focus:ring-2 focus:ring-electric/50 text-white" placeholder="Enter second person's name">
                    </div>
                </div>
                <button type="submit" class="w-full md:w-auto px-8 py-3 bg-electric text-midnight font-bold rounded-lg hover:bg-electric/80 transition duration-300 shadow-lg hover:shadow-electric/50">Set Candidates</button>
            </form>
            <div id="candidates-message" class="mt-4 text-sm"></div>
        </div>

        <div class="dashboard-card rounded-2xl p-8 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-electric">Voting Results</h2>
                <button id="refresh-results" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-300">Refresh</button>
            </div>
            <div id="results-container" class="space-y-6"></div>
            <div class="mt-8 pt-6 border-t border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-accent-light mb-2">Results Visibility</h3>
                        <p class="text-gray-400 text-sm">Control when users can see the final voting results</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="results-toggle" class="sr-only peer">
                        <div class="w-14 h-7 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-electric/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-electric"></div>
                        <span class="ml-3 text-sm font-medium text-gray-300" id="results-status">Hidden</span>
                    </label>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
/* ============================
   Static fallback logic
   ============================ */

let mockMode = false; // if true, use localStorage-only mode
const ADMIN_LOCAL_PASSWORD = 'admin123'; // change this if you want
const STORAGE_KEYS = {
    candidates: 'voting_candidates_v1',
    resultsVisible: 'voting_results_visible_v1',
    results: 'voting_results_v1',
    hasVoted: 'hasVoted_v1'
};

function showView(viewName) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    const target = document.getElementById(viewName + '-view');
    if (target) target.classList.add('active');
    if (viewName === 'portfolio') initPortfolio();
    if (viewName === 'vote') initVoting();
    if (viewName === 'admin-login') initAdminLogin();
    if (viewName === 'admin-dashboard') initAdminDashboard();
}

/* PORTFOLIO */
function initPortfolio() {
    // simple fade-in observer (same as original)
    const fadeIn = (entries, observer) => { entries.forEach(entry => { if (entry.isIntersecting) { const delay = parseInt(entry.target.getAttribute('data-delay')||'0',10); setTimeout(()=>entry.target.classList.add('is-visible'), delay); observer.unobserve(entry.target); } }); };
    const observer = new IntersectionObserver(fadeIn, {threshold:0.1});
    document.querySelectorAll('.fade-in-section').forEach(s => observer.observe(s));

    // countdown
    const countdownEl = document.getElementById('countdown');
    if (countdownEl && !countdownEl.dataset.initialized) {
        countdownEl.dataset.initialized = 'true';
        const targetTime = new Date().getTime() + (7*24*60*60*1000);
        const update = ()=> {
            const now = Date.now();
            const dist = targetTime - now;
            if (dist < 0) { countdownEl.innerHTML = "<span class='text-electric'>THE TIME IS NOW!</span>"; return; }
            const days = Math.floor(dist/(1000*60*60*24));
            const hours = Math.floor((dist % (1000*60*60*24))/(1000*60*60));
            const minutes = Math.floor((dist % (1000*60*60))/(1000*60));
            const seconds = Math.floor((dist % (1000*60))/1000);
            const pad = n => n<10 ? '0'+n : n;
            countdownEl.innerHTML = `<span class="text-electric">${days}</span><span class="text-gray-500 text-base mx-1 font-sans">D</span><span class="text-electric">${pad(hours)}</span><span class="text-gray-500 text-base mx-1 font-sans">H</span><span class="text-accent-light">${pad(minutes)}</span><span class="text-gray-500 text-base mx-1 font-sans">M</span><span class="text-accent-light">${pad(seconds)}</span><span class="text-gray-500 text-base mx-1 font-sans">S</span>`;
        };
        update(); setInterval(update, 1000);
    }
}

/* VOTING: try to fetch candidates from server; if fail, switch to mock/local */
let selectedCandidate = null;
let candidates = [];
let hasVoted = false;

function initVoting() {
    checkVotingStatus();
    loadCandidatesWithFallback();
}

function checkVotingStatus() {
    const voted = localStorage.getItem(STORAGE_KEYS.hasVoted);
    if (voted === 'true') {
        hasVoted = true;
        document.getElementById('voting-container').classList.add('hidden');
        document.getElementById('already-voted').classList.remove('hidden');
        checkResultsVisibility();
        return true;
    }
    return false;
}

async function loadCandidatesWithFallback() {
    // Attempt to request server endpoint to detect server availability
    try {
        const resp = await fetch('get-candidates.php', { method: 'GET' });
        // if server exists and returns JSON, use it
        if (resp.ok) {
            const data = await resp.json().catch(()=>null);
            if (data && data.success && data.candidates) {
                candidates = data.candidates;
                displayCandidates();
                mockMode = false;
                return;
            }
        }
        // else fall through to mock
        throw new Error('Server did not return valid candidates');
    } catch (err) {
        console.warn('Server unreachable or invalid response ‚Äî switching to local mode.', err);
        mockMode = true;
        // ensure there are candidate names in localStorage, otherwise seed defaults
        let stored = localStorage.getItem(STORAGE_KEYS.candidates);
        if (stored) {
            candidates = JSON.parse(stored);
        } else {
            candidates = [{ name: 'Person One' }, { name: 'Person Two' }];
            localStorage.setItem(STORAGE_KEYS.candidates, JSON.stringify(candidates));
            // also seed results
            const defaultResults = { person1_name: candidates[0].name, person2_name: candidates[1].name, person1_votes: 0, person2_votes: 0 };
            localStorage.setItem(STORAGE_KEYS.results, JSON.stringify(defaultResults));
            localStorage.setItem(STORAGE_KEYS.resultsVisible, JSON.stringify(false));
        }
        displayCandidates();
    }
}

function displayCandidates() {
    const container = document.getElementById('candidates-container');
    container.innerHTML = '';
    candidates.forEach((candidate, index) => {
        const initial = candidate.name.charAt(0).toUpperCase();
        const card = document.createElement('div');
        card.className = 'candidate-card text-center';
        card.innerHTML = `
            <div class="candidate-circle bg-gradient-to-br from-electric to-0891B2" data-index="${index}">
                <span class="relative z-10">${initial}</span>
            </div>
            <div class="candidate-name">${candidate.name}</div>
        `;
        const circle = card.querySelector('.candidate-circle');
        circle.addEventListener('click', () => selectCandidate(index));
        container.appendChild(card);
    });
    document.getElementById('submit-vote-btn').disabled = true;
    selectedCandidate = null;
}

function selectCandidate(index) {
    selectedCandidate = index;
    document.querySelectorAll('.candidate-circle').forEach((circle, i) => {
        circle.classList.toggle('selected', i === index);
    });
    document.getElementById('submit-vote-btn').disabled = false;
}

/* Submit vote ‚Äî will try server; on failure (or in mockMode) update localStorage */
document.getElementById('submit-vote-btn').addEventListener('click', async () => {
    if (selectedCandidate === null) return;
    const candidate = candidates[selectedCandidate];
    if (!candidate) return;
    if (!mockMode) {
        try {
            const response = await fetch('submit-vote.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ candidate: candidate.name })
            });
            const data = await response.json();
            if (data.success) {
                localStorage.setItem(STORAGE_KEYS.hasVoted, 'true');
                hasVoted = true;
                document.getElementById('voting-container').classList.add('hidden');
                document.getElementById('vote-success').classList.remove('hidden');
                checkResultsVisibility();
                return;
            } else {
                alert('Error submitting vote: ' + (data.message || 'Unknown error'));
                return;
            }
        } catch (err) {
            console.warn('Server submit failed ‚Äî switching to mock mode', err);
            mockMode = true; // fall through to mock write
        }
    }
    // mock/local mode write:
    const results = JSON.parse(localStorage.getItem(STORAGE_KEYS.results) || '{}') || {};
    if (!results.person1_name) {
        // initialize results from current candidates
        results.person1_name = candidates[0].name;
        results.person2_name = candidates[1].name;
        results.person1_votes = results.person1_votes || 0;
        results.person2_votes = results.person2_votes || 0;
    }
    if (candidate.name === results.person1_name) results.person1_votes = (results.person1_votes || 0) + 1;
    else if (candidate.name === results.person2_name) results.person2_votes = (results.person2_votes || 0) + 1;
    else {
        // candidate changed names ‚Äî map by index
        if (selectedCandidate === 0) results.person1_votes = (results.person1_votes || 0) + 1;
        else results.person2_votes = (results.person2_votes || 0) + 1;
    }
    localStorage.setItem(STORAGE_KEYS.results, JSON.stringify(results));
    localStorage.setItem(STORAGE_KEYS.hasVoted, 'true');
    hasVoted = true;
    document.getElementById('voting-container').classList.add('hidden');
    document.getElementById('vote-success').classList.remove('hidden');
    checkResultsVisibility();
});

/* Results visibility check ‚Äî tries server then falls back */
async function checkResultsVisibility() {
    if (!mockMode) {
        try {
            const resp = await fetch('get-results.php');
            const data = await resp.json();
            if (data.success && data.resultsVisible) {
                displayResults(data.results, hasVoted ? 'results-content-voted' : 'results-content');
                const previewId = hasVoted ? 'results-preview-voted' : 'results-preview';
                document.getElementById(previewId).classList.remove('hidden');
            }
            return;
        } catch (err) {
            console.warn('get-results.php failed ‚Äî falling back to local results', err);
            mockMode = true;
        }
    }
    // local results
    const visible = JSON.parse(localStorage.getItem(STORAGE_KEYS.resultsVisible) || 'false');
    if (visible) {
        const results = JSON.parse(localStorage.getItem(STORAGE_KEYS.results) || '{}');
        displayResults(results, hasVoted ? 'results-content-voted' : 'results-content');
        const previewId = hasVoted ? 'results-preview-voted' : 'results-preview';
        document.getElementById(previewId).classList.remove('hidden');
    }
}

function displayResults(results, containerId) {
    const container = document.getElementById(containerId);
    results.person1_name = results.person1_name || (candidates[0] && candidates[0].name) || 'Person 1';
    results.person2_name = results.person2_name || (candidates[1] && candidates[1].name) || 'Person 2';
    results.person1_votes = Number(results.person1_votes || 0);
    results.person2_votes = Number(results.person2_votes || 0);
    const total = results.person1_votes + results.person2_votes;
    if (total === 0) { container.innerHTML = '<p class="text-gray-400">No votes yet.</p>'; return; }
    const p1 = Math.round((results.person1_votes / total) * 100);
    const p2 = Math.round((results.person2_votes / total) * 100);
    container.innerHTML = `
        <div class="space-y-4">
            <div>
                <div class="flex justify-between mb-2">
                    <span class="text-accent-light font-semibold">${results.person1_name}</span>
                    <span class="text-electric font-bold">${p1}% (${results.person1_votes} votes)</span>
                </div>
                <div class="h-6 bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-electric to-0891B2 transition-all duration-500" style="width: ${p1}%"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between mb-2">
                    <span class="text-accent-light font-semibold">${results.person2_name}</span>
                    <span class="text-electric font-bold">${p2}% (${results.person2_votes} votes)</span>
                </div>
                <div class="h-6 bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-electric to-0891B2 transition-all duration-500" style="width: ${p2}%"></div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <p class="text-gray-400">Total Votes: <span class="text-electric font-bold">${total}</span></p>
            </div>
        </div>
    `;
}

/* ADMIN LOGIN / DASHBOARD: local-mode friendly */
function initAdminLogin() {
    const toggle = document.getElementById('toggle-password');
    const pwInput = document.getElementById('password');
    const eye = document.querySelector('#toggle-password');
    eye.addEventListener('click', ()=> {
        pwInput.type = pwInput.type === 'password' ? 'text' : 'password';
    });

    const form = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorMessage.classList.add('hidden');
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        // Try server first
        if (!mockMode) {
            try {
                const resp = await fetch('admin-login.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password })});
                const data = await resp.json();
                if (data.success) {
                    sessionStorage.setItem('adminToken', data.token);
                    showView('admin-dashboard');
                    return;
                } else {
                    errorMessage.textContent = data.message || 'Invalid credentials';
                    errorMessage.classList.remove('hidden');
                    return;
                }
            } catch (err) {
                console.warn('admin-login.php failed; using local admin', err);
                mockMode = true;
            }
        }
        // local admin fallback
        if (password === ADMIN_LOCAL_PASSWORD) {
            sessionStorage.setItem('adminToken', 'local-admin-token');
            showView('admin-dashboard');
        } else {
            errorMessage.textContent = 'Invalid credentials (local)';
            errorMessage.classList.remove('hidden');
        }
    });
}

/* ADMIN DASHBOARD init */
async function initAdminDashboard() {
    if (!checkAuth()) return;
    if (!mockMode) {
        // verify token with server if available
        try {
            const token = sessionStorage.getItem('adminToken');
            const resp = await fetch('verify-admin.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token })});
            const data = await resp.json();
            if (!data.success) { sessionStorage.removeItem('adminToken'); showView('admin-login'); return; }
        } catch (err) {
            console.warn('verify-admin.php failed; local admin assumed', err);
            mockMode = true;
        }
    }
    await loadCandidatesAdmin();
    await loadResultsAdmin();
}

function checkAuth() {
    const token = sessionStorage.getItem('adminToken');
    if (!token) { showView('admin-login'); return false; }
    return true;
}

/* load candidates in admin panel (server first, fallback to local) */
async function loadCandidatesAdmin() {
    if (!mockMode) {
        try {
            const resp = await fetch('get-candidates.php');
            const data = await resp.json();
            if (data.success && data.candidates) {
                document.getElementById('person1').value = data.candidates[0].name;
                document.getElementById('person2').value = data.candidates[1].name;
                candidates = data.candidates;
                return;
            }
        } catch (err) {
            console.warn('get-candidates.php failed in admin load', err);
            mockMode = true;
        }
    }
    // local
    const stored = JSON.parse(localStorage.getItem(STORAGE_KEYS.candidates) || 'null');
    if (stored && stored.length>=2) {
        candidates = stored;
        document.getElementById('person1').value = stored[0].name;
        document.getElementById('person2').value = stored[1].name;
    } else {
        // use defaults if none
        candidates = [{name:'Person One'},{name:'Person Two'}];
        document.getElementById('person1').value = candidates[0].name;
        document.getElementById('person2').value = candidates[1].name;
        localStorage.setItem(STORAGE_KEYS.candidates, JSON.stringify(candidates));
    }
}

/* set candidates form submit */
document.getElementById('candidates-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const person1 = document.getElementById('person1').value.trim();
    const person2 = document.getElementById('person2').value.trim();
    const msg = document.getElementById('candidates-message');
    if (!person1 || !person2) { msg.textContent='Please enter both names'; msg.className='mt-4 text-sm text-red-400'; return; }

    if (!mockMode) {
        try {
            const response = await fetch('set-candidates.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ person1, person2, token: sessionStorage.getItem('adminToken') })});
            const data = await response.json();
            if (data.success) {
                msg.textContent = 'Candidates set successfully!';
                msg.className = 'mt-4 text-sm text-green-400';
                await loadResultsAdmin();
                return;
            } else {
                msg.textContent = data.message || 'Error setting candidates';
                msg.className = 'mt-4 text-sm text-red-400';
                return;
            }
        } catch (err) {
            console.warn('set-candidates.php failed; writing locally', err);
            mockMode = true;
        }
    }
    // local write
    const newCandidates = [{name:person1},{name:person2}];
    localStorage.setItem(STORAGE_KEYS.candidates, JSON.stringify(newCandidates));
    // update results object with new names (keep counts if exist)
    const results = JSON.parse(localStorage.getItem(STORAGE_KEYS.results) || '{}');
    results.person1_name = person1;
    results.person2_name = person2;
    results.person1_votes = results.person1_votes || 0;
    results.person2_votes = results.person2_votes || 0;
    localStorage.setItem(STORAGE_KEYS.results, JSON.stringify(results));
    msg.textContent = 'Candidates set successfully (local)!';
    msg.className = 'mt-4 text-sm text-green-400';
    await loadResultsAdmin();
    // reflect in vote view
    candidates = newCandidates;
    displayCandidates();
});

/* load results for admin */
async function loadResultsAdmin() {
    if (!mockMode) {
        try {
            const resp = await fetch('get-results.php?admin=true');
            const data = await resp.json();
            if (data.success) {
                displayAdminResults(data.results);
                updateResultsToggle(data.resultsVisible);
                return;
            }
        } catch (err) {
            console.warn('get-results.php admin failed; using local results', err);
            mockMode = true;
        }
    }
    const results = JSON.parse(localStorage.getItem(STORAGE_KEYS.results) || '{}');
    const visible = JSON.parse(localStorage.getItem(STORAGE_KEYS.resultsVisible) || 'false');
    displayAdminResults(results);
    updateResultsToggle(visible);
}

function displayAdminResults(results) {
    const container = document.getElementById('results-container');
    results.person1_name = results.person1_name || (candidates[0] && candidates[0].name) || 'Person 1';
    results.person2_name = results.person2_name || (candidates[1] && candidates[1].name) || 'Person 2';
    results.person1_votes = Number(results.person1_votes || 0);
    results.person2_votes = Number(results.person2_votes || 0);
    const total = results.person1_votes + results.person2_votes;
    if (total === 0) { container.innerHTML = '<p class="text-gray-400">No votes yet.</p>'; return; }
    const p1 = Math.round((results.person1_votes / total) * 100);
    const p2 = Math.round((results.person2_votes / total) * 100);
    container.innerHTML = `
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="stat-card rounded-xl p-6">
                <div class="text-center mb-4">
                    <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-electric to-0891B2 flex items-center justify-center text-4xl font-bold text-white mb-3">${results.person1_name.charAt(0).toUpperCase()}</div>
                    <h3 class="text-2xl font-bold text-accent-light">${results.person1_name}</h3>
                </div>
                <div class="text-center">
                    <div class="text-5xl font-bold text-electric mb-2">${p1}%</div>
                    <div class="text-xl text-gray-300">${results.person1_votes} votes</div>
                </div>
                <div class="mt-4 h-4 bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-electric to-0891B2 transition-all duration-500" style="width:${p1}%"></div>
                </div>
            </div>
            <div class="stat-card rounded-xl p-6">
                <div class="text-center mb-4">
                    <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-electric to-0891B2 flex items-center justify-center text-4xl font-bold text-white mb-3">${results.person2_name.charAt(0).toUpperCase()}</div>
                    <h3 class="text-2xl font-bold text-accent-light">${results.person2_name}</h3>
                </div>
                <div class="text-center">
                    <div class="text-5xl font-bold text-electric mb-2">${p2}%</div>
                    <div class="text-xl text-gray-300">${results.person2_votes} votes</div>
                </div>
                <div class="mt-4 h-4 bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-electric to-0891B2 transition-all duration-500" style="width:${p2}%"></div>
                </div>
            </div>
        </div>
        <div class="text-center p-4 bg-gray-800 rounded-lg">
            <p class="text-gray-400">Total Votes: <span class="text-electric font-bold text-2xl">${total}</span></p>
        </div>
    `;
}

function updateResultsToggle(visible) {
    const toggle = document.getElementById('results-toggle');
    const status = document.getElementById('results-status');
    toggle.checked = !!visible;
    status.textContent = visible ? 'Visible' : 'Hidden';
}

/* results toggle change event */
document.getElementById('results-toggle').addEventListener('change', async (e) => {
    const visible = e.target.checked;
    if (!mockMode) {
        try {
            const response = await fetch('toggle-results.php', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ visible, token: sessionStorage.getItem('adminToken') })
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById('results-status').textContent = visible ? 'Visible' : 'Hidden';
                return;
            } else {
                e.target.checked = !visible;
                alert('Error toggling results visibility');
                return;
            }
        } catch (err) {
            console.warn('toggle-results.php failed; will toggle locally', err);
            mockMode = true;
        }
    }
    localStorage.setItem(STORAGE_KEYS.resultsVisible, JSON.stringify(visible));
    document.getElementById('results-status').textContent = visible ? 'Visible' : 'Hidden';
});

/* refresh results button */
document.getElementById('refresh-results').addEventListener('click', ()=> loadResultsAdmin());

/* logout */
document.getElementById('logout-btn').addEventListener('click', ()=> {
    sessionStorage.removeItem('adminToken');
    showView('admin-login');
});

/* initialize portfolio on load */
window.addEventListener('DOMContentLoaded', ()=> {
    initPortfolio();
});
</script>
</body>
</html>
